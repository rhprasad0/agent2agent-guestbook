name: Build and Push to ECR

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/build-and-push.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: eks-lab/guestbook

permissions:
  id-token: write        # Required for OIDC
  contents: read         # Required for checkout
  security-events: write # Required for uploading SARIF results
  # Note: To update aws-devops-lab repo, you need a PAT stored in secrets.GITOPS_PAT

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::407645373626:role/dev-github-actions-ecr-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image for ARM64
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build for ARM64 (linux/arm64) architecture
          # This matches AWS Graviton2/Graviton3 processors (t4g, c7g, m7g instance types)
          docker buildx build \
            --platform linux/arm64 \
            --load \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          echo "IMAGE_FULL_NAME=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV

      - name: Run Trivy vulnerability scanner
        id: trivy-scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true  # Continue to upload results even if vulnerabilities found
        with:
          image-ref: ${{ env.IMAGE_FULL_NAME }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Exit with 1 if HIGH/CRITICAL found
          trivyignores: '.trivyignore'  # Use documented exceptions
          limit-severities-for-sarif: true  # Only fail on HIGH/CRITICAL, not MEDIUM/LOW

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()  # Upload even if scan fails
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Generate SBOM with Trivy
        if: always()  # Generate SBOM regardless of scan result
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_FULL_NAME }}
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Upload SBOM artifact
        if: always()  # Upload SBOM regardless of scan result
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: sbom.json
          retention-days: 30

      - name: Fail if vulnerabilities found
        if: steps.trivy-scan.outcome == 'failure'
        run: |
          echo "❌ HIGH or CRITICAL vulnerabilities detected!"
          echo "❌ Image will NOT be pushed to ECR"
          echo ""
          echo "View vulnerability details:"
          echo "- GitHub Security tab for Trivy findings"
          echo "- Actions artifacts for SBOM"
          echo ""
          echo "To fix:"
          echo "1. Update base image or dependencies"
          echo "2. Or add exceptions to .trivyignore with justification"
          exit 1

      - name: Push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Only reached if Trivy scan passed
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "✅ Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          
      - name: Tag image as scanned
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Add a scan-passed tag to indicate this image passed security scanning
          # This can be used by admission controllers to verify image provenance
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:scan-passed-$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:scan-passed-$IMAGE_TAG
          echo "✅ Scan attestation tag pushed: scan-passed-$IMAGE_TAG"

      - name: Image scan summary
        run: |
          echo "✅ Trivy security scan passed"
          echo "✅ SBOM generated and uploaded as artifact"
          echo "✅ Scan attestation tag created"
          echo "✅ ECR native scanning enabled on repository"
          echo ""
          echo "View results:"
          echo "- GitHub Security tab for Trivy findings"
          echo "- Actions artifacts for SBOM"
          echo "- ECR Console: https://console.aws.amazon.com/ecr/repositories/private/407645373626/$ECR_REPOSITORY"

  update-manifest:
    name: Update Kubernetes Manifest
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout aws-devops-lab repo
        uses: actions/checkout@v4
        with:
          repository: rhprasad0/aws-devops-lab
          ref: main
          token: ${{ secrets.GITOPS_PAT }}  # PAT with repo scope to push to aws-devops-lab
          path: aws-devops-lab

      - name: Update kustomization.yaml with new image tag
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd aws-devops-lab/k8s/guestbook
          
          # Update the image tag in kustomization.yaml
          sed -i "s/newTag: .*/newTag: ${IMAGE_TAG}/" kustomization.yaml
          
          echo "✅ Updated kustomization.yaml with image tag: ${IMAGE_TAG}"
          cat kustomization.yaml

      - name: Commit and push manifest changes
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd aws-devops-lab
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add k8s/guestbook/kustomization.yaml
          git commit -m "chore: update guestbook image to ${IMAGE_TAG}

          Automated update from agent2agent-guestbook build
          Image: 407645373626.dkr.ecr.us-east-1.amazonaws.com/eks-lab/guestbook:${IMAGE_TAG}"
          
          git push

      - name: GitOps deployment summary
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "✅ Manifest updated in aws-devops-lab repo"
          echo "✅ Argo CD will automatically sync (automated: true, selfHeal: true)"
          echo ""
          echo "Monitor deployment:"
          echo "- Argo CD UI: kubectl port-forward svc/argocd-server -n argocd 8080:443"
          echo "- Watch pods: kubectl get pods -n guestbook -w"
          echo "- Check rollout: kubectl rollout status deployment/guestbook -n guestbook"
